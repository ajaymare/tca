name: Hybrid Config Analysis

on:
  pull_request:
    paths:
      - 'gitops/**'

jobs:
  analyze-configs:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Validate Istio Configs
        uses: tetratelabs/tca-action@main
        with:
          tis-password: ${{ secrets.TIS_PASSWORD }}
          mesh-config: |-
            /gitops/bookinfo/bookinfo-gateway.yaml
            /gitops/bookinfo/bookinfo.yaml
          kube-config: ${{ secrets.KUBECONFIG }}
          github-token: ${{ secrets.GH_TOKEN }}
          local-only: true

      - name: Comment on PR with results
        uses: thollander/actions-comment-pull-request@v3
        with:
          file-path: ${{ steps.tca.outputs.result-file }}

      - name: Optionally Fail if there are errors
        run: |
          if [ ${{ env.error-count }} -gt 0 ]; then
            exit 1
